openapi: 3.0.0
info:
  title: Pawn Manager API
  description: API for managing pawn shop operations, including loans, customers, payments, collateral, disbursements, and stores.
  version: '1.0'
servers:
  - url: /v1
    description: V1 API Endpoint

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- COMMON ---
    PaginationMeta:
      type: object
      properties:
        totalItems:
          type: integer
        totalPages:
          type: integer
        currentPage:
          type: integer
        itemsPerPage:
          type: integer

    ImageItem:
      type: object
      properties:
        url:
          type: string
        id:
          type: string

    # --- CUSTOMER ---
    CustomerType:
      type: string
      enum: [REGULAR, VIP]

    CreateCustomerDTO:
      type: object
      required:
        - fullName
        - dob
        - nationalId
        - nationalIdIssueDate
        - nationalIdIssuePlace
        - phone
        - customerType
        - monthlyIncome
      properties:
        fullName:
          type: string
          maxLength: 200
        dob:
          type: string
          format: date
          description: YYYY-MM-DD
        nationalId:
          type: string
          description: 12 digits
        nationalIdIssueDate:
          type: string
          format: date
        nationalIdIssuePlace:
          type: string
        phone:
          type: string
        email:
          type: string
          format: email
        address:
          type: string
        customerType:
          $ref: '#/components/schemas/CustomerType'
        monthlyIncome:
          type: number
          minimum: 3000000
        creditScore:
          type: integer
          minimum: 0
          maximum: 1000

    UpdateCustomerRequest:
      type: object
      properties:
        fullName:
          type: string
        phone:
          type: string
        email:
          type: string
          format: email
        address:
          type: string
        monthlyIncome:
          type: number

    ActiveLoan:
      type: object
      properties:
        id:
          type: string
        loanCode:
          type: string
        loanAmount:
          type: number
        remainingAmount:
          type: number
        status:
          type: string
        startDate:
          type: string

    LoanHistory:
      type: object
      properties:
        totalLoans:
          type: integer
        totalBorrowed:
          type: number
        totalRepaid:
          type: number
        defaultCount:
          type: integer

    # --- VALUATION ---
    ValuationRequestDto:
      type: object
      required:
        - collateralTypeId
        - brand
        - model
        - year
        - condition
      properties:
        collateralTypeId:
          type: integer
        brand:
          type: string
        model:
          type: string
        year:
          type: integer
        condition:
          type: string
          enum: [EXCELLENT, GOOD, FAIR, POOR]
        mileage:
          type: integer
        assessmentAmount:
          type: number

    ValuationResponse:
      type: object
      properties:
        assetType:
          type: string
        brand:
          type: string
        model:
          type: string
        year:
          type: integer
        condition:
          type: string
        suggestedMarketValue:
          type: number
        minValue:
          type: number
        maxValue:
          type: number
        confidenceLevel:
          type: string
        ltvRatio:
          type: number
        maxLoanAmount:
          type: number
        depreciationRate:
          type: number
        valuationDate:
          type: string
          format: date-time
        valuationMethod:
          type: string
          enum: [AI, MANUAL]
        notes:
          type: string

    # --- WRAPPERS ---
    CustomerResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/CustomerResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    StoreResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/StoreResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CollateralAssetResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/CollateralAssetResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    LiquidationCollateralResponse:
      type: object
      properties:
        liquidationId:
          type: string
        status:
          type: string
        createdAt:
          type: string
          format: date-time
        message:
          type: string
        collateralAssetId:
          type: string

    LiquidationResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/LiquidationCollateralResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    ValuationResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/ValuationResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    BooleanResponseWrapper:
      type: object
      properties:
        data:
          type: boolean
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CustomerResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fullName:
          type: string
        dob:
          type: string
          format: date
        nationalId:
          type: string
        phone:
          type: string
        email:
          type: string
        address:
          type: string
        customerType:
          $ref: '#/components/schemas/CustomerType'
        monthlyIncome:
          type: number
        creditScore:
          type: integer
        createdAt:
          type: string
          format: date-time
        images:
          type: object # JSON
        activeLoans:
          type: array
          items:
            $ref: '#/components/schemas/ActiveLoan'
        loanHistory:
          $ref: '#/components/schemas/LoanHistory'
        fatherName:
          type: string
        fatherPhone:
          type: string
        fatherOccupation:
          type: string
        motherName:
          type: string
        motherPhone:
          type: string
        motherOccupation:
          type: string
        spouseName:
          type: string
        spousePhone:
          type: string
        spouseOccupation:
          type: string
        occupation:
          type: string
        workplace:
          type: string
        emergencyContactName:
          type: string
        emergencyContactPhone:
          type: string

    CustomerListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/CustomerResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # --- LOAN ---
    RepaymentMethod:
      type: string
      enum: [EQUAL_INSTALLMENT, INTEREST_ONLY]

    LoanStatus:
      type: string
      enum: [PENDING, REJECTED, ACTIVE, CLOSED, OVERDUE]

    CreateLoanDto:
      type: object
      required:
        - customerId
        - loanAmount
        - repaymentMethod
        - loanTypeId
        - collateralIds
      properties:
        customerId:
          type: string
          format: uuid
        loanAmount:
          type: number
        repaymentMethod:
          $ref: '#/components/schemas/RepaymentMethod'
        loanTypeId:
          type: integer
        notes:
          type: string
        collateralIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1

    ApproveLoanDto:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ACTIVE, REJECTED]
        note:
          type: string

    UpdateLoanDto:
      type: object
      properties:
        loanAmount:
          type: number
        repaymentMethod:
          $ref: '#/components/schemas/RepaymentMethod'
        loanTypeId:
          type: integer
        notes:
          type: string

    LoanResponseDto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        loanCode:
          type: string
        customerId:
          type: string
        storeId:
          type: string
        loanAmount:
          type: number
        repaymentMethod:
          $ref: '#/components/schemas/RepaymentMethod'
        loanTypeId:
          type: integer
        loanTypeName:
          type: string
        durationMonths:
          type: number
        appliedInterestRate:
          type: number
        latePaymentPenaltyRate:
          type: number
        totalInterest:
          type: number
        totalFees:
          type: number
        totalRepayment:
          type: number
        monthlyPayment:
          type: number
        status:
          $ref: '#/components/schemas/LoanStatus'
        startDate:
          type: string
          format: date-time
          nullable: true
        activatedAt:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          nullable: true
        createdBy:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        customer:
          $ref: '#/components/schemas/CustomerResponse'
        collateral:
          type: array
          items:
            $ref: '#/components/schemas/CollateralAssetResponse'

    LoanSummaryResponseDto:
      type: object
      properties:
        id:
          type: string
        loanCode:
          type: string
        customerId:
          type: string
        storeName:
          type: string
        loanAmount:
          type: number
        totalRepayment:
          type: number
        monthlyPayment:
          type: number
        durationMonths:
          type: number
        loanTypeName:
          type: string
        repaymentMethod:
          $ref: '#/components/schemas/RepaymentMethod'
        status:
          $ref: '#/components/schemas/LoanStatus'
        startDate:
          type: string
        activatedAt:
          type: string
        createdAt:
          type: string

    ListLoansResponseDto:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LoanSummaryResponseDto'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # --- PAYMENT ---
    PaymentMethod:
      type: string
      enum: [CASH, BANK_TRANSFER]

    PaymentType:
      type: string
      enum: [PERIODIC, EARLY, PAYOFF, ADJUSTMENT]

    PaymentRequestDto:
      type: object
      required:
        - loanId
        - amount
        - paymentMethod
        - paymentType
      properties:
        loanId:
          type: string
          format: uuid
        amount:
          type: number
        paymentMethod:
          $ref: '#/components/schemas/PaymentMethod'
        paymentType:
          $ref: '#/components/schemas/PaymentType'
        notes:
          type: string

    PaymentResponse:
      type: object
      description: Simplified response
      properties:
        id:
          type: string
        amount:
          type: number
        status:
          type: string

    PaymentListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        loanId:
          type: string
          format: uuid
        storeId:
          type: string
          format: uuid
        amount:
          type: number
        paymentType:
          $ref: '#/components/schemas/PaymentType'
        paymentMethod:
          $ref: '#/components/schemas/PaymentMethod'
        paidAt:
          type: string
          format: date-time
        referenceCode:
          type: string

    ListPaymentsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PaymentListItem'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # --- DISBURSEMENT ---
    DisbursementMethod:
      type: string
      enum: [CASH, BANK_TRANSFER]

    DisbursementRequestDto:
      type: object
      required:
        - loanId
        - storeId
        - amount
        - disbursementMethod
        - recipientName
      properties:
        loanId:
          type: string
          format: uuid
        storeId:
          type: string
          format: uuid
        amount:
          type: number
        disbursementMethod:
          $ref: '#/components/schemas/DisbursementMethod'
        recipientName:
          type: string
        recipientIdNumber:
          type: string
        witnessName:
          type: string
        bankTransferRef:
          type: string
        bankAccountNumber:
          type: string
        bankName:
          type: string
        notes:
          type: string

    DisbursementListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        loanId:
          type: string
          format: uuid
        amount:
          type: number
        disbursementMethod:
          $ref: '#/components/schemas/DisbursementMethod'
        disbursedAt:
          type: string
        referenceCode:
          type: string
        recipientName:
          type: string
        loanCode:
          type: string

    DisbursementDetailsResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        loanId:
          type: string
        loanCode:
          type: string
        amount:
          type: number
        disbursementMethod:
          $ref: '#/components/schemas/DisbursementMethod'
        disbursedAt:
          type: string
        referenceCode:
          type: string
        recipientName:
          type: string
        recipientIdNumber:
          type: string
        bankTransferRef:
          type: string
        bankAccountNumber:
          type: string
        bankName:
          type: string
        notes:
          type: string

    ListDisbursementsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DisbursementListItem'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    DisbursementResponseWrapper:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/DisbursementDetailsResponse'

    # --- COLLATERAL ---
    CollateralStatus:
      type: string
      enum: [PROPOSED, PLEDGED, STORED, RELEASED, REJECTED, LIQUIDATING, SOLD]

    CreateCollateralDTO:
      type: object
      required:
        - collateralTypeId
        - ownerName
        - appraisedValue
      properties:
        collateralTypeId:
          type: integer
        ownerName:
          type: string
        collateralInfo:
          type: object
          additionalProperties: true
        status:
          $ref: '#/components/schemas/CollateralStatus'
        loanId:
          type: string
          format: uuid
        storageLocation:
          type: string
        receivedDate:
          type: string
          format: date
        appraisedValue:
          type: number
        appraisalDate:
          type: string
          format: date-time
        appraisalNotes:
          type: string

    PatchCollateralDTO:
      type: object
      properties:
        ownerName:
          type: string
        collateralInfo:
          type: object
        status:
          $ref: '#/components/schemas/CollateralStatus'
        storageLocation:
          type: string

    UpdateLocationRequest:
      type: object
      required:
        - storageLocation
      properties:
        storageLocation:
          type: string

    CollateralAssetResponse:
      type: object
      properties:
        id:
          type: string
        collateralTypeId:
          type: integer
        ownerName:
          type: string
        collateralInfo:
          type: object
        status:
          $ref: '#/components/schemas/CollateralStatus'
        loanId:
          type: string
        storageLocation:
          type: string
        receivedDate:
          type: string
        appraisedValue:
          type: number
        ltvRatio:
          type: number

    CollateralAssetListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/CollateralAssetResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    InitiateLiquidationDto:
      type: object
      required:
        - collateralId
        - minimumSalePrice
      properties:
        collateralId:
          type: string
          format: uuid
        minimumSalePrice:
          type: number

    FinalizeLiquidationDto:
      type: object
      required:
        - sellPrice
      properties:
        sellPrice:
          type: number

    # --- STORE ---
    CreateStoreDTO:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        address:
          type: string
        storeInfo:
          type: object
        isActive:
          type: boolean
          default: true

    UpdateStoreDTO:
      type: object
      properties:
        name:
          type: string
        address:
          type: string
        isActive:
          type: boolean

    StoreResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        address:
          type: string
        isActive:
          type: boolean

    StoreListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/StoreResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # --- REPORTS ---
    RevenueReportQuery:
      type: object
      required:
        - startDate
        - endDate
      properties:
        startDate:
          type: string
          format: date
          description: YYYY-MM-DD
        endDate:
          type: string
          format: date
          description: YYYY-MM-DD
        storeId:
          type: string
          format: uuid

    RevenueBreakdown:
      type: object
      properties:
        interest:
          type: number
        serviceFee:
          type: number
        lateFee:
          type: number
        liquidationExcess:
          type: number

    ExpenseBreakdown:
      type: object
      properties:
        loanDisbursement:
          type: number

    RevenueReportResponse:
      type: object
      properties:
        date:
          type: string
          format: date
        totalRevenue:
          type: number
        breakdown:
          $ref: '#/components/schemas/RevenueBreakdown'
        totalExpense:
          type: number
        expenseBreakdown:
          $ref: '#/components/schemas/ExpenseBreakdown'

    RevenueSummary:
      type: object
      properties:
        totalRevenue:
          type: number
        totalInterest:
          type: number
        totalServiceFee:
          type: number
        totalLateFee:
          type: number
        totalLiquidationExcess:
          type: number
        totalExpense:
          type: number
        totalLoanDisbursement:
          type: number

    RevenueReportListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/RevenueReportResponse'
        summary:
          $ref: '#/components/schemas/RevenueSummary'

    DailyLogResponse:
      type: object
      properties:
        date:
          type: string
          format: date
        newLoans:
          type: array
          items:
            $ref: '#/components/schemas/DailyLogEntry'
        closedLoans:
          type: array
          items:
            $ref: '#/components/schemas/DailyLogEntry'
        summary:
          $ref: '#/components/schemas/DailyLogSummary'

    DailyLogEntry:
      type: object
      properties:
        contractId:
          type: string
        customerName:
          type: string
        nationalId:
          type: string
        address:
          type: string
        phone:
          type: string
        collateralDescription:
          type: string
        loanAmount:
          type: number
        loanDate:
          type: string
          format: date
        closedDate:
          type: string
          format: date
        status:
          type: string

    DailyLogSummary:
      type: object
      properties:
        totalNewLoans:
          type: number
        totalClosedLoans:
          type: number
        totalNewLoanAmount:
          type: number

    QuarterlyReportResponse:
      type: object
      properties:
        quarter:
          type: integer
        year:
          type: integer
        period:
          type: string
        statistics:
          $ref: '#/components/schemas/QuarterlyStatistics'
        compliance:
          $ref: '#/components/schemas/QuarterlyCompliance'

    QuarterlyStatistics:
      type: object
      properties:
        totalLoansIssued:
          type: number
        totalLoanAmount:
          type: number
        totalLoansClosed:
          type: number
        totalLoansActive:
          type: number
        totalLoansOverdue:
          type: number
        totalCollateralsReceived:
          type: number
        totalCollateralsReleased:
          type: number
        totalLiquidations:
          type: number
        totalRevenue:
          type: number
        revenueBreakdown:
          type: object
          properties:
            interest:
              type: number
            serviceFee:
              type: number
            lateFee:
              type: number
            liquidationProfit:
              type: number
        assetBreakdown:
          type: array
          items:
            $ref: '#/components/schemas/AssetBreakdownItem'
        employees:
          $ref: '#/components/schemas/EmployeeReport'
        security:
          $ref: '#/components/schemas/SecurityPersonnelReport'

    AssetBreakdownItem:
      type: object
      properties:
        category:
          type: string
        receivedCount:
          type: number
        receivedValue:
          type: number
        releasedCount:
          type: number
        releasedValue:
          type: number
        liquidatedCount:
          type: number
        liquidatedValue:
          type: number
        inStockCount:
          type: number
        inStockValue:
          type: number

    EmployeeReport:
      type: object
      properties:
        total:
          type: number
        male:
          type: number
        female:
          type: number

    SecurityPersonnelReport:
      type: object
      properties:
        count:
          type: number

    QuarterlyCompliance:
      type: object
      properties:
        averageLTV:
          type: number
        averageInterestRate:
          type: number
        kycCompletionRate:
          type: number

    # --- LOCATION ---
    ProvinceResponse:
      type: object
      properties:
        id:
          type: string
        code:
          type: string
        name:
          type: string

    WardResponse:
      type: object
      properties:
        id:
          type: string
        code:
          type: string
        name:
          type: string
        parentId:
          type: string

    # --- CONFIGURATIONS ---
    ConfigurationResponse:
      type: object
      properties:
        key:
          type: string
          description: Unique parameter key identifier
        value:
          type: string
          description: Current value stored as string
        group:
          type: string
          enum: [RATES, LIMITS, SYSTEM]
        description:
          type: string
        dataType:
          type: string
          enum: [STRING, DECIMAL, INTEGER, BOOLEAN, JSON]

    UpdateConfigurationDto:
      type: object
      required:
        - value
      properties:
        value:
          type: string
        description:
          type: string

    # --- LOAN TYPES ---
    LoanTypeResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the loan type
        name:
          type: string
          description: Name of the loan type
        description:
          type: string
          description: Description of the loan type
        durationMonths:
          type: number
          description: Duration of the loan type in months
        interestRateMonthly:
          type: number
          description: Annual interest rate of the loan type
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the loan type was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the loan type was last updated

    CreateLoanTypeDto:
      type: object
      required:
        - name
        - durationMonths
        - interestRateMonthly
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
        durationMonths:
          type: number
          minimum: 1
        interestRateMonthly:
          type: number
          minimum: 0

    UpdateLoanTypeDto:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
        durationMonths:
          type: number
          minimum: 1
        interestRateMonthly:
          type: number
          minimum: 0

    # --- REPAYMENT SCHEDULE ---
    RepaymentItemStatus:
      type: string
      enum: [PENDING, PAID, OVERDUE]

    RepaymentScheduleItemResponse:
      type: object
      properties:
        id:
          type: string
        loanId:
          type: string
        periodNumber:
          type: integer
        dueDate:
          type: string
          format: date
        beginningBalance:
          type: number
        principalAmount:
          type: number
        interestAmount:
          type: number
        feeAmount:
          type: number
        totalAmount:
          type: number
        status:
          $ref: '#/components/schemas/RepaymentItemStatus'
        paidPrincipal:
          type: number
        paidInterest:
          type: number
        paidFee:
          type: number
        paidAt:
          type: string
          format: date-time
          nullable: true

    CustomerInfoResponse:
      type: object
      properties:
        fullName:
          type: string
        phone:
          type: string
        nationalId:
          type: string

    OverdueLoanResponse:
      type: object
      properties:
        loanId:
          type: string
          format: uuid
        loanCode:
          type: string
        loanStatus:
          $ref: '#/components/schemas/LoanStatus'
        customer:
          $ref: '#/components/schemas/CustomerInfoResponse'
        totalOverdueAmount:
          type: number
        overduePeriodsCount:
          type: integer
        earliestOverdueDate:
          type: string
          format: date
        daysOverdue:
          type: integer
        overdueItems:
          type: array
          items:
            $ref: '#/components/schemas/RepaymentScheduleItemResponse'

    OverdueLoanResponseWrapper:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OverdueLoanResponse'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # --- COMMUNICATION ---
    NotificationType:
      type: string
      enum:
        [
          LOAN_APPROVED,
          INTEREST_REMINDER,
          OVERDUE_REMINDER,
          LIQUIDATION_WARNING,
          PAYMENT_CONFIRMATION,
        ]

    NotificationChannel:
      type: string
      enum: [SMS, EMAIL, PHONE_CALL, IN_PERSON]

    NotificationStatus:
      type: string
      enum:
        [PENDING, SENT, DELIVERED, FAILED, ANSWERED, NO_ANSWER, PROMISE_TO_PAY]

    LogCommunicationDto:
      type: object
      required:
        - loanId
        - type
        - channel
        - status
      properties:
        loanId:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/NotificationType'
        channel:
          $ref: '#/components/schemas/NotificationChannel'
        status:
          $ref: '#/components/schemas/NotificationStatus'
        subject:
          type: string
          maxLength: 200
        notes:
          type: string
          maxLength: 1000
        callDuration:
          type: integer
          minimum: 1
        promiseToPayDate:
          type: string
          format: date

    NotificationLogResponse:
      type: object
      properties:
        id:
          type: string
        type:
          $ref: '#/components/schemas/NotificationType'
        channel:
          $ref: '#/components/schemas/NotificationChannel'
        status:
          $ref: '#/components/schemas/NotificationStatus'
        loanId:
          type: string
        customerId:
          type: string
        customerName:
          type: string
        customerPhone:
          type: string
        subject:
          type: string
        message:
          type: string
        recipientContact:
          type: string
        callDuration:
          type: number
        employeeId:
          type: string
        notes:
          type: string
        promiseToPayDate:
          type: string
        sentAt:
          type: string
        createdAt:
          type: string
        updatedAt:
          type: string

    # --- LOAN SIMULATION ---
    LoanSimulationRequestDto:
      type: object
      required:
        - loanAmount
        - totalFeeRate
        - loanTypeId
        - repaymentMethod
      properties:
        loanAmount:
          type: number
          minimum: 1
        totalFeeRate:
          type: number
          minimum: 0
        loanTypeId:
          type: integer
        repaymentMethod:
          $ref: '#/components/schemas/RepaymentMethod'

    LoanSimulationScheduleItem:
      type: object
      properties:
        periodNumber:
          type: integer
        dueDate:
          type: string
          format: date
        beginningBalance:
          type: number
        principalAmount:
          type: number
        interestAmount:
          type: number
        feeAmount:
          type: number
        totalAmount:
          type: number

    LoanSimulationResponse:
      type: object
      properties:
        loanAmount:
          type: number
        durationMonths:
          type: integer
        productType:
          type: string
        appliedInterestRate:
          type: number
        appliedMgmtFeeRateMonthly:
          type: number
        totalCustodyFeeRate:
          type: number
        totalInterest:
          type: number
        totalFees:
          type: number
        totalRepayment:
          type: number
        monthlyPayment:
          type: number
        schedule:
          type: array
          items:
            $ref: '#/components/schemas/LoanSimulationScheduleItem'

security:
  - bearerAuth: []

paths:
  # --- LOAN TYPES ---
  /loan-types:
    get:
      summary: List loan types
      tags: [Loan Types]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/LoanTypeResponse'
                required:
                  - data
    post:
      summary: Create loan type
      tags: [Loan Types]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLoanTypeDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/LoanTypeResponse'
                required:
                  - data

  /loan-types/{id}:
    patch:
      summary: Update loan type
      tags: [Loan Types]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLoanTypeDto'
      responses:
        '201':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/LoanTypeResponse'
                required:
                  - data

  # --- LOAN SIMULATIONS ---
  /loan-simulations:
    post:
      summary: Simulate loan repayment schedule
      tags: [Loan Simulations]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoanSimulationRequestDto'
      responses:
        '201':
          description: Simulation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanSimulationResponse'

  # --- CUSTOMERS ---
  /customers:
    get:
      summary: List customers
      tags: [Customers]
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerListResponse'
    post:
      summary: Create customer
      tags: [Customers]
      requestBody:
        content:
          multipart/form-data:
            schema:
              allOf:
                - $ref: '#/components/schemas/CreateCustomerDTO'
                - type: object
                  properties:
                    mattruoc:
                      type: string
                      format: binary
                    matsau:
                      type: string
                      format: binary
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponseWrapper'

  /customers/{id}:
    get:
      summary: Get customer
      tags: [Customers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponseWrapper'
    patch:
      summary: Update customer
      tags: [Customers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          multipart/form-data:
            schema:
              allOf:
                - $ref: '#/components/schemas/UpdateCustomerRequest'
                - type: object
                  properties:
                    mattruoc:
                      type: string
                      format: binary
                    matsau:
                      type: string
                      format: binary
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponseWrapper'

  # --- LOANS ---
  /loans:
    get:
      summary: List loans
      tags: [Loans]
      parameters:
        - name: q
          in: query
          schema:
            type: string
        - name: storeId
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/LoanStatus'
        - name: customerId
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListLoansResponseDto'
    post:
      summary: Create loan
      tags: [Loans]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLoanDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  loan: { $ref: '#/components/schemas/LoanResponseDto' }

  /loans/overdue:
    get:
      summary: Get overdue loans with their overdue repayment items
      tags: [Loans]
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: storeId
          in: query
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: sortBy
          in: query
          schema:
            type: string
        - name: sortOrder
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverdueLoanResponseWrapper'

  /loans/{id}:
    get:
      summary: Get loan
      tags: [Loans]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanResponseDto'
    patch:
      summary: Update loan details
      tags: [Loans]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLoanDto'
      responses:
        '200':
          description: Updated

  /loans/{id}/status:
    patch:
      summary: Approve/Reject loan
      tags: [Loans]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveLoanDto'
      responses:
        '200':
          description: Status updated

  # --- PAYMENTS ---
  /payments:
    get:
      summary: List payments
      tags: [Payments]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
        - name: sortBy
          in: query
          schema:
            type: string
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
        - name: loanId
          in: query
          schema:
            type: string
        - name: storeId
          in: query
          schema:
            type: string
        - name: paymentMethod
          in: query
          schema:
            $ref: '#/components/schemas/PaymentMethod'
        - name: paymentType
          in: query
          schema:
            $ref: '#/components/schemas/PaymentType'
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          schema:
            type: string
            format: date
        - name: minAmount
          in: query
          schema:
            type: number
        - name: maxAmount
          in: query
          schema:
            type: number
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPaymentsResponse'
    post:
      summary: Create Payment
      tags: [Payments]
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequestDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
        '409':
          description: Duplicate Idempotency Key

  # --- DISBURSEMENT ---
  /disbursements:
    get:
      summary: List disbursements
      tags: [Disbursements]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
        - name: loanId
          in: query
          schema:
            type: string
            format: uuid
        - name: storeId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListDisbursementsResponse'
    post:
      summary: Create disbursement
      tags: [Disbursements]
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisbursementRequestDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DisbursementResponseWrapper'

  # --- COLLATERAL ---
  /collateral-assets:
    get:
      summary: List collateral assets
      tags: [Collateral]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetListResponse'
    post:
      summary: Create collateral
      tags: [Collateral]
      requestBody:
        content:
          multipart/form-data:
            schema:
              allOf:
                - $ref: '#/components/schemas/CreateCollateralDTO'
                - type: object
                  properties:
                    files:
                      type: array
                      items:
                        type: string
                        format: binary
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetResponseWrapper'

  /collateral-assets/{id}:
    get:
      summary: Get collateral
      tags: [Collateral]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetResponseWrapper'
    patch:
      summary: Update collateral
      tags: [Collateral]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          multipart/form-data:
            schema:
              allOf:
                - $ref: '#/components/schemas/PatchCollateralDTO'
                - type: object
                  properties:
                    files:
                      type: array
                      items:
                        type: string
                        format: binary
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetResponseWrapper'

  /collaterals/{id}/location:
    put:
      summary: Update collateral location
      tags: [Collateral]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLocationRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BooleanResponseWrapper'

  # --- LIQUIDATION ---
  /liquidations:
    post:
      summary: Initiate liquidation process
      tags: [Liquidation]
      description: Mark asset as LIQUIDATING and set minimum sale price. Loan must be OVERDUE.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiateLiquidationDto'
      responses:
        '201':
          description: Liquidation initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetResponseWrapper'

  /liquidations/{collateralId}/sell:
    post:
      summary: Finalize asset sale
      tags: [Liquidation]
      description: Record final sale price and close asset lifecycle (Status SOLD).
      parameters:
        - name: collateralId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FinalizeLiquidationDto'
      responses:
        '201':
          description: Asset sold
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollateralAssetResponseWrapper'

  # --- ASSET VALUATION ---
  /asset-valuations:
    post:
      summary: Create asset valuation
      tags: [Valuation]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValuationRequestDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValuationResponseWrapper'

  # --- STORES ---
  /stores:
    get:
      summary: List stores
      tags: [Stores]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreListResponse'
    post:
      summary: Create store
      tags: [Stores]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoreDTO'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponseWrapper'

  /stores/{id}:
    get:
      summary: Get store
      tags: [Stores]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponseWrapper'
    patch:
      summary: Update store
      tags: [Stores]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoreDTO'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponseWrapper'

  # --- REPORTS ---
  /reports/revenue:
    get:
      summary: Get revenue report
      tags: [Reports]
      parameters:
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: storeId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevenueReportListResponse'

  /reports/daily-log:
    get:
      summary: Get daily log
      tags: [Reports]
      parameters:
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: storeId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyLogResponse'

  /reports/quarterly:
    get:
      summary: Get quarterly compliance report
      tags: [Reports]
      parameters:
        - name: year
          in: query
          required: true
          schema:
            type: integer
            example: 2024
        - name: quarter
          in: query
          required: true
          schema:
            type: integer
            example: 1
        - name: storeId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuarterlyReportResponse'

  # --- LOCATION ---
  /provinces:
    get:
      summary: Get provinces
      tags: [Location]
      parameters:
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProvinceResponse'

  /provinces/{code}/wards:
    get:
      summary: Get wards by province code
      tags: [Location]
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WardResponse'

  # --- CONFIGURATIONS ---
  /configurations:
    get:
      tags: [System Configurations]
      summary: List all system configurations
      parameters:
        - name: group
          in: query
          schema:
            type: string
            enum: [RATES, LIMITS, SYSTEM]
      responses:
        200:
          description: List retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConfigurationResponse'

  /configurations/{key}:
    put:
      tags: [System Configurations]
      summary: Update system configuration
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          description: Parameter Key
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConfigurationDto'
      responses:
        200:
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigurationResponse'

  # --- REPAYMENT SCHEDULE ---
  /loans/{loanId}/repayment-schedule:
    get:
      summary: Get loan repayment schedule
      tags: [Repayment Schedule]
      parameters:
        - name: loanId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RepaymentScheduleItemResponse'

  /repayment-schedules/{id}:
    get:
      summary: Get single repayment schedule item
      tags: [Repayment Schedule]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/RepaymentScheduleItemResponse'

  # --- COMMUNICATION ---
  /communications/log:
    post:
      summary: Log a communication attempt
      tags: [Communication]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogCommunicationDto'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationLogResponse'

  /communications/loans/{loanId}/history:
    get:
      summary: Get communication history for a loan
      tags: [Communication]
      parameters:
        - name: loanId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NotificationLogResponse'

  /communications/promises-to-pay:
    get:
      summary: Get upcoming promise-to-pay commitments
      tags: [Communication]
      parameters:
        - name: fromDate
          in: query
          schema:
            type: string
            format: date
        - name: toDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NotificationLogResponse'

// ==================================================
// GENERATOR & DATASOURCE
// ==================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================================================
// ENUMS
// ==================================================
enum CustomerType {
  REGULAR
  VIP
}

enum RepaymentMethod {
  EQUAL_INSTALLMENT
  INTEREST_ONLY
}

enum LoanStatus {
  PENDING
  REJECTED
  ACTIVE
  CLOSED
  OVERDUE
}

enum RepaymentItemStatus {
  PENDING
  PAID
  OVERDUE
}

enum PaymentType {
  PERIODIC
  EARLY
  LATE_FEE
  PENALTY
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
}

enum PaymentComponent {
  PRINCIPAL
  INTEREST
  LATE_FEE
  PENALTY
  SERVICE_FEE
}

enum AssetStatus {
  PROPOSED
  PLEDGED
  STORED
  RELEASED
  REJECTED
  LIQUIDATING
  SOLD
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum DisbursementMethod {
  CASH
  BANK_TRANSFER
}

// ==================================================
// LOAN PRODUCT TYPE
// ==================================================
model LoanType {
  id                    Int     @id @default(autoincrement())
  name                  String  @unique
  description           String?

  durationMonths        Int
  interestRateMonthly   Decimal @db.Decimal(7, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  loans Loan[]
}

// ==================================================
// CUSTOMER
// ==================================================
model Customer {
  id            String       @id @default(uuid()) @db.Uuid
  fullName      String
  dob           DateTime     @db.Date
  nationalId    String       @unique
  phone         String?      @unique
  email         String?      @unique
  address       String?
  customerType  CustomerType
  monthlyIncome Decimal?
  creditScore   Int?

  images      Json

  loans     Loan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

// ==================================================
// LOAN
// ==================================================
model Loan {
  id              String   @id @default(uuid()) @db.Uuid
  customerId      String   @db.Uuid

  // ---- LOAN TERMS (SNAPSHOT) ----
  loanAmount            Decimal
  repaymentMethod       RepaymentMethod
  loanTypeId            Int

  durationMonths      Int          // snapshot
  appliedInterestRate  Decimal       // snapshot

  // rate phi phat
  latePaymentPenaltyRate        Decimal @db.Decimal(7, 4)  // snapshot

  // ---- CALCULATED SNAPSHOT ----
  totalInterest   Decimal
  totalFees       Decimal
  totalRepayment  Decimal
  monthlyPayment  Decimal

  // ---- LIFECYCLE ----
  startDate       DateTime?
  status          LoanStatus @default(PENDING)

  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?

  activatedAt     DateTime?
  remainingAmount Decimal @default(0)

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())

  // ---- RELATIONS ----
  loanProductType   LoanType      @relation(fields: [loanTypeId], references: [id])
  customer          Customer             @relation(fields: [customerId], references: [id])
  repaymentSchedule RepaymentScheduleDetail[]
  payments          LoanPayment[]
  collaterals       Asset[]
}


// ==================================================
// REPAYMENT SCHEDULE
// ==================================================
model RepaymentScheduleDetail {
  id               String              @id @default(uuid()) @db.Uuid
  loanId           String              @db.Uuid
  periodNumber     Int
  dueDate          DateTime            @db.Date
  beginningBalance Decimal
  principalAmount  Decimal
  interestAmount   Decimal
  totalAmount      Decimal
  status           RepaymentItemStatus @default(PENDING)
  paidPrincipal    Decimal?            @default(0)
  paidInterest     Decimal?            @default(0)
  feeAmount        Decimal             @default(0) // mgmt + custody fee cho kỳ này
  paidFee          Decimal?            @default(0)
  paidAt           DateTime?

  loan Loan @relation(fields: [loanId], references: [id])
}

// ==================================================
// PAYMENTS
// ==================================================
model LoanPayment {
  id                 String        @id @default(uuid()) @db.Uuid
  idempotencyKey     String?       @unique
  loanId             String        @db.Uuid
  amount             Decimal
  paymentType        PaymentType
  paymentMethod      PaymentMethod
  paidAt             DateTime      @default(now())
  referenceCode      String?
  recorderEmployeeId String? // clerk user id (string)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @default(now())

  loan        Loan                @relation(fields: [loanId], references: [id])
  allocations PaymentAllocation[]
}

// Allocation per payment
model PaymentAllocation {
  id            String           @id @default(uuid()) @db.Uuid
  paymentId     String           @db.Uuid
  componentType PaymentComponent
  amount        Decimal
  note          String?

  payment LoanPayment @relation(fields: [paymentId], references: [id])
}

// ==================================================
// COLLATERAL & APPRAISAL
// ==================================================
model AssetType {
  id                    Int      @id @default(autoincrement())
  name                  String
  // mgmtFeeRateMonthly    Decimal @default(0) @db.Decimal(7, 4)  -> Parameter
  custodyFeeRateMonthly Decimal @default(0) @db.Decimal(7, 4)
  assets    Asset[]
}

model Asset {
  id              String      @id @default(uuid()) @db.Uuid
  assetTypeId         Int
  ownerName       String

  assetInfo       Json
  
  status          AssetStatus @default(PROPOSED)
  loanId          String?     @db.Uuid
  storageLocation String?
  receivedDate    DateTime? @db.Date

  appraisedValue Decimal?
  ltvRatio       Decimal?
  appraisalDate  DateTime?
  appraisalNotes String?

  images         Json

  sellPrice       Decimal?
  sellDate       DateTime? @db.Date

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  loan Loan? @relation(fields: [loanId], references: [id])
  assetType   AssetType @relation(fields: [assetTypeId], references: [id])
}

// ==================================================
// DOCUMENT RECORD
// ==================================================
// model DocumentRecord {
//   id          String        @id @default(uuid()) @db.Uuid
//   entityType  DocumentEntity
//   entityId    String        @db.Uuid
//   docType     String
//   docNumber   String
//   issuedDate  DateTime      @db.Date
//   expiryDate  DateTime?
//   isValid     Boolean       @default(true)
//   createdAt   DateTime      @default(now())
// }

// ==================================================
// SYSTEM PARAMETER
// ==================================================
model SystemParameter {
  id          Int      @id @default(autoincrement())
  paramGroup  String?
  paramKey    String
  paramValue  String
  dataType    String?  @default("STRING")
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@unique([paramGroup, paramKey])
}
